name: Release
on:
  push:
    tags:
      - 'v*.*.*'
permissions:
  contents: write
jobs:
  release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Verify tag is on main branch
      - name: Verify tag on main branch
        shell: bash
        run: |
          git fetch origin main
          TAG_COMMIT=$(git rev-list -n 1 ${{ github.ref }})
          if ! git merge-base --is-ancestor $TAG_COMMIT origin/main; then
            echo "Error: Tag ${{ github.ref_name }} is not on the main branch"
            exit 1
          fi
          echo "✓ Tag ${{ github.ref_name }} is on main branch"
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          cache: true
          cache-dependency-path: '**/*.csproj'
      
      - name: Restore
        run: dotnet restore
      
      - name: Build
        run: dotnet build --no-restore --configuration Release
      
      - name: Test
        run: dotnet test --no-build --configuration Release --verbosity normal
      
      - name: Publish win-x64
        run: dotnet publish src/Ziyada/Ziyada.csproj -c Release -r win-x64 --self-contained -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o publish/win-x64
      
      - name: Publish win-arm64
        run: dotnet publish src/Ziyada/Ziyada.csproj -c Release -r win-arm64 --self-contained -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o publish/win-arm64
      
      - name: Create ZIP artifacts
        shell: bash
        run: |
          cd publish/win-x64
          7z a -tzip ../../Ziyada-${{ github.ref_name }}-win-x64.zip Ziyada.exe
          cd ../win-arm64
          7z a -tzip ../../Ziyada-${{ github.ref_name }}-win-arm64.zip Ziyada.exe
          cd ../..
          echo "✓ Created Ziyada-${{ github.ref_name }}-win-x64.zip"
          echo "✓ Created Ziyada-${{ github.ref_name }}-win-arm64.zip"
      
      - name: Rename executables with architecture
        shell: bash
        run: |
          mv publish/win-x64/Ziyada.exe publish/win-x64/Ziyada-win-x64.exe
          mv publish/win-arm64/Ziyada.exe publish/win-arm64/Ziyada-win-arm64.exe
          echo "✓ Renamed executables with architecture suffix"
      
      - name: Determine if prerelease
        id: prerelease
        shell: bash
        run: |
          if [[ "${{ github.ref_name }}" =~ -rc|-alpha|-beta ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a prerelease version"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release"
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          prerelease: ${{ steps.prerelease.outputs.prerelease }}
          files: |
            Ziyada-${{ github.ref_name }}-win-x64.zip
            Ziyada-${{ github.ref_name }}-win-arm64.zip
            publish/win-x64/Ziyada-win-x64.exe
            publish/win-arm64/Ziyada-win-arm64.exe
